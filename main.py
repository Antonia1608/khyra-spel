[Adding the full main.py content from our latest version]